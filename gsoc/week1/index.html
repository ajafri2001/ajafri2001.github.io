<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://ajafri2001.github.io/ name=base><title>
            
                GSoC 2025 Week #1
            
        </title><meta content="GSoC 2025 Week #1" property=og:title><link href=https://ajafri2001.github.io/fonts.css rel=stylesheet><script src=https://ajafri2001.github.io/js/codeblock.js></script><script src=https://ajafri2001.github.io/js/toc.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://ajafri2001.github.io/atom.xml rel=alternate title=ajafri2001 type=application/atom+xml><link href=https://ajafri2001.github.io/theme/light.css rel=stylesheet><link href=https://ajafri2001.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://ajafri2001.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://ajafri2001.github.io/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://ajafri2001.github.io/>ajafri2001</a><div class=socials><a class=social href=https://github.com/ajafri2001/ rel=me> <img alt=github src=https://ajafri2001.github.io/icons/social/github.svg> </a><a class=social href=https://discord.com/users/1237543552733544559 rel=me> <img alt=discord src=https://ajafri2001.github.io/icons/social/discord.svg> </a></div></div><nav><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://ajafri2001.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://ajafri2001.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>GSoC 2025 Week #1<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-06-08</time> :: 543 Words <span class=tags-label>:: Tags:</span><span class=tags> <a class=post-tag href=https://ajafri2001.github.io/tags/scala/>scala</a> , <a class=post-tag href=https://ajafri2001.github.io/tags/metals/>metals</a> , <a class=post-tag href=https://ajafri2001.github.io/tags/gsoc/>gsoc</a> </span></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://ajafri2001.github.io/gsoc/week1/#introduction>Introduction</a><li><a href=https://ajafri2001.github.io/gsoc/week1/#stuff-accomplished-in-the-first-week>Stuff Accomplished in the first week</a><li><a href=https://ajafri2001.github.io/gsoc/week1/#next-week-goals>Next Week Goals</a></ul></div><section class=body><h2 id=introduction><a aria-label="Anchor link for: introduction" class=zola-anchor href=#introduction>Introduction</a></h2><p>This is going to be <em>(hopefully)</em> a weekly series of blog posts covering the technical details of the stuff implemented by me and my wonderful mentor <a href=https://github.com/tgodzik>@tgodik</a> for Scala Center GSOC 2025. This will be the first post in the series and I'll cover what has been done so far in the first week of the coding period.<p>The first week has a bit of a special circumstance since even though the coding period began in June 2nd of this year, I asked my mentor if we could start early and have an extra month for free ðŸ˜….<p>In hindsight that was the best thing I could've done since that extra time was proved to be really helpful and was put to good use.<h2 id=stuff-accomplished-in-the-first-week><a aria-label="Anchor link for: stuff-accomplished-in-the-first-week" class=zola-anchor href=#stuff-accomplished-in-the-first-week>Stuff Accomplished in the first week</a></h2><p>Okay, so far me and my mentor have managed to get a couple of stuff done. The high level steps that needed to be done are as follows:<ol><li>Get client/editor and metals to recognize <code>.scala.html</code> files.<li>Set up mapping for goto/hover etc</ol><p>For the first point, detecting <code>.scala.html</code> files in vscode via adding an entry in the <a href=https://github.com/scalameta/metals-vscode>metals-vscode's</a> <code>package.json</code> was really straightforward<pre class=language-json data-lang=json style=color:#bfbab0;background-color:#0f1419><code class=language-json data-lang=json><span>  {
</span><span>    </span><span style=color:#c2d94c>"id"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"scala"</span><span style=color:#bfbab0cc>,
</span><span>    </span><span style=color:#c2d94c>"extensions"</span><span style=color:#bfbab0cc>: </span><span>[
</span><span>      </span><span style=color:#c2d94c>".scala.html"
</span><span>    ]
</span><span>  }
</span></code></pre><p>Another thing we needed to do was allow metals itself recognize twirl's files, we did this via adding the following snippet<pre class=language-scala data-lang=scala style=color:#bfbab0;background-color:#0f1419><code class=language-scala data-lang=scala><span style=color:#f73>def </span><span style=color:#ffb454>isTwirlTemplate</span><span>: </span><span style=color:#f73>Boolean </span><span style=color:#f29668>=</span><span> filename</span><span style=color:#f29668>.</span><span>endsWith(</span><span style=color:#c2d94c>".scala.html"</span><span>)
</span></code></pre><p>in some key locations inside <a href=https://github.com/scalameta/metals/blob/main/mtags-shared/src/main/scala/scala/meta/internal/mtags/CommonMtagsEnrichments.scala>CommonMtagsEnrichments.scala</a> and in <a href=https://github.com/ajafri2001/metals/blob/main/mtags/src/main/scala/scala/meta/internal/mtags/ScalametaCommonEnrichments.scala>ScalametaCommonEnrichments.scala</a>. This makes it so we can easily have logic specific to twirl templates in metals itself.<div class=note-container><div class=note-header><div class=note-icon><p>Key Point!</div></div><div class=note-content><p>It is important to note that twirl templates are compiled to scala source code at compile time, by default under <code>target/scala-x.x.x/twirl/main/html/*.template.scala</code></div></div><p>Next we needed to add support for compiling twirl files via the <a href=https://github.com/playframework/twirl/tree/main/sbt-twirl/src>sbt-twirl</a> plugin, sbt-twirl expects twirl files to be under <code>src/main/twirl/*.scala.html</code> this is still being done and hopefully it gets resolved in week 2 ðŸ˜….<p>To implement LSP specific stuff like hover/goto-definition, we need a way to "map" between twirl templates and the scala source code it compiles down to. Thankfully, the compiled source files have additional generated content that is appended at the end of the file and it is really helpful for mapping, and an example would be here:<pre class=language-txt data-lang=txt style=color:#bfbab0;background-color:#0f1419><code class=language-txt data-lang=txt><span>/*
</span><span>  -- GENERATED --
</span><span>  SOURCE: src/main/twirl/example1.scala.html
</span><span>  HASH: 65c3b28a0faadb5f545e21fb821007050023d27d
</span><span>  MATRIX: 601->1|709->16|746->27|770->31
</span><span>  LINES: 15->1|20->2|20->2|20->2
</span><span>  -- GENERATED --
</span><span> */
</span><span>
</span></code></pre><p>As you can see in the "Lines" row here, this implies that line 1 of the twirl file maps to line 15 of the compiled scala file, now whenever the the client request information for twirl file, we can simply give them this line number. We aren't taking into account character number here, but that's alright. We can do it next week or the next week after it :)<p>Okay, now to extract this information out of the compiled file, we can use regex to do something like this, which sorta works.<pre class=language-scala data-lang=scala style=color:#bfbab0;background-color:#0f1419><code class=language-scala data-lang=scala><span style=color:#f73>val </span><span>pattern </span><span style=color:#f29668>= </span><span style=color:#c2d94c>"""(\d+)->(\d+)"""</span><span style=color:#f29668>.</span><span>r
</span><span style=color:#f73>val </span><span>number_matching </span><span style=color:#f29668>=
</span><span>pattern</span><span style=color:#f29668>.</span><span>findAllIn(templateString)</span><span style=color:#f29668>.</span><span>toList
</span><span>
</span><span style=color:#5c6773;font-style:italic>// Use latter half of matched regex; first half corresponds to the "Matrix" row
</span><span style=color:#f73>val </span><span>numbers </span><span style=color:#f29668>=</span><span> number_matching</span><span style=color:#f29668>.</span><span>drop(number_matching</span><span style=color:#f29668>.</span><span>length / </span><span style=color:#f29718>2</span><span>)
</span><span>
</span><span style=color:#5c6773;font-style:italic>// Map[Int, Int](1 -> 15, 2 -> 20, 3 -> 21)  SourceFile -> CompiledFile
</span><span style=color:#f73>val </span><span>mappingMap: </span><span style=color:#39bae6;font-style:italic>Map</span><span>[</span><span style=color:#f73>Int</span><span style=color:#bfbab0cc>, </span><span style=color:#f73>Int</span><span>] </span><span style=color:#f29668>=</span><span> numbers</span><span style=color:#f29668>.</span><span>map { </span><span style=color:#f29718>s </span><span style=color:#f73>=>
</span><span style=color:#f73>val </span><span>parts </span><span style=color:#f29668>=</span><span> s</span><span style=color:#f29668>.</span><span>split(</span><span style=color:#c2d94c>"->"</span><span>)
</span><span style=color:#f73>val </span><span>a </span><span style=color:#f29668>=</span><span> parts(</span><span style=color:#f29718>0</span><span>)</span><span style=color:#f29668>.</span><span>toInt
</span><span style=color:#f73>val </span><span>b </span><span style=color:#f29668>=</span><span> parts(</span><span style=color:#f29718>1</span><span>)</span><span style=color:#f29668>.</span><span>toInt
</span><span>b -> a
</span><span>}</span><span style=color:#f29668>.</span><span>toMap
</span></code></pre><h2 id=next-week-goals><a aria-label="Anchor link for: next-week-goals" class=zola-anchor href=#next-week-goals>Next Week Goals</a></h2><p>My goal for the next week is, to have thorough tests on the mapping and achieve reasonable sbt integration for metals, and that basic stuff like hover works.</section></article></main></div>